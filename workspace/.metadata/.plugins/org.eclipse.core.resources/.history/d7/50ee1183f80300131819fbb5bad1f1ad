package controller;

import java.awt.Component;
import java.awt.event.*;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.Vector;

import javax.imageio.ImageIO;
import javax.swing.JButton;
import javax.swing.JFileChooser;
import javax.swing.JLayeredPane;
import javax.xml.parsers.SAXParser;
import javax.xml.parsers.SAXParserFactory;

import org.xml.sax.Attributes;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;
import org.xml.sax.helpers.DefaultHandler;

import peakml.IPeak;

public class Controller {
    
	private static model.Model theModel;
    private static view.View  theView;
    
    private static String pathID = "tbr01100";
    
    public Controller(model.Model model, view.View view) {
        this.theModel = model;
        this.theView  = view;
        
        theView.addLoadPeaksListener(new LoadPeaksListener());
        theView.addDisplayPeakPlotsListener(new DisplayPeakPlotsListener());
        theView.addLoadIdentificationsListener(new LoadIdentificationsListener());
        theView.addLoadPathListener(new LoadPathListener());
    }

    class LoadPeaksListener implements ActionListener {
    	public void actionPerformed(ActionEvent e) {
    		final JFileChooser fc = new JFileChooser("Choose PeakML File");
    		int returnVal = fc.showOpenDialog((Component) e.getSource());
    		if (returnVal == JFileChooser.APPROVE_OPTION) {
                File file = fc.getSelectedFile();
                theView.displayPeakList(theModel.loadPeaks(file));
    		}
    		// else ?
    	}
    }
    
    class DisplayPeakPlotsListener implements ActionListener {
    	public void actionPerformed(ActionEvent e) {
    		int[] selected = theView.getLinkFrame().getPeakTable().getSelectedRows();
    		Vector<IPeak> selectedPeaks = theModel.getPeakStore().getSelectedPeaks(selected);
    		for (IPeak peak : selectedPeaks){
    			theView.getPeakFrame().recursive(peak, 'c');
    			// draw other tab plots
    		}
    		theView.getPeakFrame().setVisible(true); /////////////////////// size is wrong (???)
    		theView.getPeakFrame().pack();
//    		theView.getPeakFrame().drawPlot(selectedPeaks, 'c');
    	}
    }
    
    class LoadIdentificationsListener implements ActionListener {
    	public void actionPerformed(ActionEvent e) {
    		final JFileChooser fc = new JFileChooser("Chooose Identification File");
    		int returnVal = fc.showOpenDialog((Component) e.getSource());
    		if (returnVal == JFileChooser.APPROVE_OPTION) {
                File file = fc.getSelectedFile();
                // if no path loaded: just display in list
                // if path loaded: display on pathway and list
//                theView.getPathFrame().displayIdentifications(theModel.loadIdentifications(file));
                theModel.loadIdentifications(file);
                theView.getPathFrame().setVisible(true);
                theView.getPathFrame().pack();
//                theView.displayPeakList(theModel.loadPeaks(file));
    		}
    	}
    }
    
    class LoadPathListener implements ActionListener {
    	public void actionPerformed(ActionEvent e) {
    		// get path id
    		System.out.println("into actioPerformed");
    		String pathID = "tbr01100";
			try{
				URL pathImgUrl = new URL("http://rest.kegg.jp/get/" + pathID + "/image");
				BufferedImage pathImg = ImageIO.read(pathImgUrl);
				theView.getPathFrame().getPathPanel().setImage(pathImg, theView.getPathFrame().getPathPanel().getWidth(),
						theView.getPathFrame().getPathPanel().getHeight());
				System.out.println("going into parsing");
				parseKGML(pathID, pathImg.getWidth(), pathImg.getHeight());
				System.out.println("out of parsing");
			} catch (MalformedURLException urlException) {
				System.out.println("URL is malformed: http://rest.kegg.jp/get/" + pathID + "/image");
				urlException.printStackTrace();
			} catch (IOException e1) {
				// TODO Auto-generated catch block
				e1.printStackTrace();
			}
//    		try {
//				theView.getPathFrame().getImg(pathID);
//			} catch (IOException e1) {
//				// TODO Auto-generated catch block
//				e1.printStackTrace();
//			}
    	}
    }
    
    public static void parseKGML(String pID, int imgW, int imgH){
		
		try {
			 
			SAXParserFactory factory = SAXParserFactory.newInstance();
			SAXParser saxParser = factory.newSAXParser();
			
			DefaultHandler handler = new kgmlHandler(theView.getPathFrame().getWidth(), theView.getPathFrame().getHeight(),
					imgW, imgH, theModel, theView);
			
			saxParser.parse(new InputSource(new URL("http://rest.kegg.jp/get/" + pID + "/kgml").openStream()), handler);
			
		} catch (Exception e) {
			e.printStackTrace();
		}
    }
}